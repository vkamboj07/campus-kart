<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusKart - My Account</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="account.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <!-- Top Header -->
    <div class="top-header">
        <div class="container">
            <div class="top-header-content">
                <span class="promo-text">Back to college sale upto 50% OFF on your first rent!</span>
                <div class="top-header-right">
                    <span class="rent-now">Rent Now</span>
                    <div class="language-selector">
                        <span>English</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>CampusKart</h1>
                </div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="about.html">About</a></li>
                        <li><a href="login.html">Sign Up</a></li>
                    </ul>
                </nav>
                <div class="header-actions">
                    <div class="search-bar">
                        <input type="text" placeholder="What are you looking for?">
                        <span class="search-icon">üîç</span>
                    </div>
                    <div class="header-icons">
                        <a href="./wishlist.html" style="text-decoration: none;">
                            <span class="icon wishlist-icon">‚ù§Ô∏è <span class="badge" style="display: none;">0</span></span>
                        </a>
                        <a href="./cart.html" style="text-decoration: none;">
                            <span class="icon cart-icon">üõí <span class="badge" style="display: none;">0</span></span>
                        </a>
                        <span class="icon user-icon">üë§</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumbs -->
    <div class="breadcrumbs">
        <div class="container">
            <span>Home / My Account</span>
        </div>
    </div>

    <!-- Welcome Message -->
    <div class="welcome-message">
        <div class="container">
            <span>Welcome! <span class="username">Navyum</span></span>
        </div>
    </div>

    <!-- Account Section -->
    <section class="account-section">
        <div class="container">
            <div class="account-content">
                <div class="account-sidebar">
                    <div class="sidebar-section">
                        <h3>Manage My Account</h3>
                        <ul>
                            <li><a href="#" class="active">My Profile</a></li>
                            <li><a href="#">Address Book</a></li>
                            <li><a href="#">My Payment Options</a></li>
                        </ul>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3>My Orders</h3>
                        <ul>
                            <li><a href="#">My Returns</a></li>
                            <li><a href="#">My Cancellations</a></li>
                        </ul>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3>My Wishlist</h3>
                    </div>
                </div>
                
                <div class="account-main">
                    <div class="profile-form">
                        <h2>Edit Your Profile</h2>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" id="profile-name" value="">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="profile-email" value="">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Address</label>
                                <input type="text" id="profile-address" value="" placeholder="Enter your address">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="text" id="profile-phone" value="" placeholder="Enter your phone">
                            </div>
                        </div>
                        
                        <div class="password-section">
                            <h3>Password Changes</h3>
                            
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" id="current-password" placeholder="Current Password">
                            </div>
                            
                            <div class="form-group">
                                <label>New Password</label>
                                <input type="password" id="new-password" placeholder="New Password">
                            </div>
                            
                            <div class="form-group">
                                <label>Confirm New Password</label>
                                <input type="password" id="confirm-password" placeholder="Confirm New Password">
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button class="cancel-btn">Cancel</button>
                            <button class="save-btn" id="save-profile-btn">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer (Unified) -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Exclusive</h3>
                    <p class="footer-subtitle">About Us</p>
                    <p>We provide the best campus essentials at student-friendly prices.</p>
                    <p class="footer-subtitle" style="margin-top:16px;">Subscribe</p>
                    <p>Get 10% off your first order</p>
                    <div class="newsletter">
                        <input type="email" placeholder="Enter your email">
                        <button aria-label="Send"></button>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Support</h3>
                    <p>111 Bijoy sarani, Dhaka, DH 1515, Bangladesh.</p>
                    <p>exclusive@gmail.com</p>
                    <p>+88015-88888-9999</p>
                </div>
                <div class="footer-section">
                    <h3>Account</h3>
                    <ul>
                        <li><a href="#">My Account</a></li>
                        <li><a href="#">Login / Register</a></li>
                        <li><a href="#">Cart</a></li>
                        <li><a href="#">Wishlist</a></li>
                        <li><a href="#">Shop</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Quick Link</h3>
                    <ul>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms Of Use</a></li>
                        <li><a href="#">FAQ</a></li>
                        <li><a href="#">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Download App</h3>
                    <p>Save $3 with App New User Only</p>
                    <div class="qr-and-badges">
                        <div class="qr-code">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/8/8f/Qr-2.png" alt="QR Code">
                        </div>
                        <div class="store-badges">
                            <img src="https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg" alt="Download on the App Store">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" alt="Get it on Google Play">
                        </div>
                    </div>
                    <div class="social-icons">
                        <a href="#" aria-label="Facebook"><i class="fa-brands fa-facebook-f"></i></a>
                        <a href="#" aria-label="Twitter"><i class="fa-brands fa-x-twitter"></i></a>
                        <a href="#" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
                        <a href="#" aria-label="LinkedIn"><i class="fa-brands fa-linkedin-in"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>¬© Copyright Rimel 2022. All right reserved</p>
            </div>
        </div>
    </footer>

<script>
let currentUserData = {};

// Load user data when page loads (READ operation)
async function loadUserData() {
    const userId = localStorage.getItem("userId");
    
    if (!userId) {
        // If not logged in, redirect to login page
        window.location.href = "login.html";
        return;
    }

    try {
        // Fetch user data from backend
        const response = await fetch(`http://localhost:5000/user/${userId}`);
        const userData = await response.json();

        if (userData) {
            currentUserData = userData;
            
            // Populate form fields with user data
            document.getElementById("profile-name").value = userData.name || "";
            document.getElementById("profile-email").value = userData.email || "";
            document.getElementById("profile-address").value = userData.address || "";
            document.getElementById("profile-phone").value = userData.phone || "";
            
            // Update welcome message
            const usernameElement = document.querySelector(".username");
            if (usernameElement) {
                usernameElement.textContent = userData.name || "User";
            }
        }
    } catch (error) {
        console.error("Error loading user data:", error);
        alert("Failed to load user data. Please try again.");
    }
}

// Update profile (UPDATE operation)
document.getElementById("save-profile-btn").addEventListener("click", async function() {
    const userId = localStorage.getItem("userId");
    if (!userId) {
        alert("Please login first!");
        window.location.href = "login.html";
        return;
    }

    const name = document.getElementById("profile-name").value;
    const email = document.getElementById("profile-email").value;
    const address = document.getElementById("profile-address").value;
    const phone = document.getElementById("profile-phone").value;
    const currentPassword = document.getElementById("current-password").value;
    const newPassword = document.getElementById("new-password").value;
    const confirmPassword = document.getElementById("confirm-password").value;

    // Validation
    if (!name || !email) {
        alert("Name and Email are required!");
        return;
    }

    if (newPassword) {
        if (newPassword !== confirmPassword) {
            alert("New passwords do not match!");
            return;
        }
        if (!currentPassword) {
            alert("Please enter current password to change it!");
            return;
        }
    }

    try {
        // Verify current password if changing password
        if (newPassword && currentPassword) {
            if (currentUserData.password !== currentPassword) {
                alert("Current password is incorrect!");
                return;
            }
        }

        // Prepare update data
        const updateData = {
            name: name,
            email: email
        };

        // Add optional fields if provided
        if (address) updateData.address = address;
        if (phone) updateData.phone = phone;

        // If password is being changed, include it
        if (newPassword && currentPassword) {
            updateData.password = newPassword;
        }

        // UPDATE operation - Update user in MongoDB
        const response = await fetch(`http://localhost:5000/user/${userId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updateData)
        });

        const result = await response.json();

        if (response.ok) {
            if (newPassword) {
                alert("Profile and password updated successfully in MongoDB!");
            } else {
                alert("Profile updated successfully in MongoDB!");
            }
            
            // Reload user data to reflect changes
            await loadUserData();
            
            // Clear password fields
            document.getElementById("current-password").value = "";
            document.getElementById("new-password").value = "";
            document.getElementById("confirm-password").value = "";
        } else {
            alert(result.msg || "Failed to update profile!");
        }
    } catch (error) {
        console.error("Update error:", error);
        alert("Failed to update profile. Please check if the server is running and try again.");
    }
});

// Cancel button - Reset form
document.querySelector(".cancel-btn").addEventListener("click", function() {
    if (confirm("Are you sure you want to cancel? All unsaved changes will be lost.")) {
        loadUserData(); // Reload original data
        document.getElementById("current-password").value = "";
        document.getElementById("new-password").value = "";
        document.getElementById("confirm-password").value = "";
    }
});

// Delete account (DELETE operation)
function deleteAccount() {
    const userId = localStorage.getItem("userId");
    if (!userId) {
        alert("Please login first!");
        return;
    }

    if (confirm("Are you sure you want to delete your account? This action cannot be undone!")) {
        if (confirm("This will permanently delete all your data. Are you absolutely sure?")) {
            fetch(`http://localhost:5000/user/${userId}`, {
                method: "DELETE",
                headers: { "Content-Type": "application/json" }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.msg || "Failed to delete account");
                    });
                }
                return response.json();
            })
            .then(result => {
                if (result.msg && result.deleted) {
                    alert("Account deleted successfully from MongoDB!");
                    localStorage.removeItem("userId");
                    localStorage.removeItem("cart");
                    localStorage.removeItem("wishlist");
                    window.location.href = "index.html";
                } else {
                    alert("Failed to delete account!");
                }
            })
            .catch(error => {
                console.error("Delete error:", error);
                alert("Failed to delete account: " + error.message);
            });
        }
    }
}

// Add delete button
setTimeout(() => {
    if (!document.getElementById("delete-account-btn")) {
        const deleteBtn = document.createElement("button");
        deleteBtn.id = "delete-account-btn";
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "Delete Account";
        deleteBtn.style.cssText = "background-color: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 16px; margin-top: 20px; transition: all 0.3s;";
        deleteBtn.onmouseover = function() { this.style.backgroundColor = "#c82333"; };
        deleteBtn.onmouseout = function() { this.style.backgroundColor = "#dc3545"; };
        deleteBtn.onclick = deleteAccount;
        document.querySelector(".form-actions").appendChild(deleteBtn);
    }
}, 100);

// Update navigation based on login status
const userId = localStorage.getItem("userId");
if (userId) {
    // Keep Sign Up link pointing to login page
    const signupLink = document.querySelector('a[href="login.html"]');
    if (signupLink) {
        signupLink.innerText = "Sign Up";
        signupLink.href = "login.html";
    }
}

// Load user data when page loads
loadUserData();

// Update badges on page load
function updateAllBadges() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const wishlist = JSON.parse(localStorage.getItem("wishlist")) || [];
    
    // Update cart badge
    const cartBadges = document.querySelectorAll(".cart-icon .badge");
    const cartTotal = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartBadges.forEach(badge => {
        if (badge) {
            badge.textContent = cartTotal;
            badge.style.display = cartTotal > 0 ? "flex" : "none";
        }
    });
    
    // Update wishlist badge
    const wishlistBadges = document.querySelectorAll(".wishlist-icon .badge");
    wishlistBadges.forEach(badge => {
        if (badge) {
            badge.textContent = wishlist.length;
            badge.style.display = wishlist.length > 0 ? "flex" : "none";
        }
    });
}

updateAllBadges();
</script>

</body>
</html>
